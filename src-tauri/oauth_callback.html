<!DOCTYPE html>
<html>
<head>
    <title>Authorization Processing</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background-color: #f5f5f5; margin: 0; }
        .processing { color: #ff9900; font-size: 20px; }
        .container { max-width: 600px; margin: 0 auto; background-color: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid rgba(0,0,0,.1); border-radius: 50%; border-top-color: #09f; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h2>Authorization Processing</h2>
        <div class="spinner"></div>
        <p class="processing">Please wait while we complete your authorization...</p>
        <p>This window will automatically process your authorization and close when complete.</p>
    </div>
    
    <script>
        let token = null;
        let error = null;
        let service = null;
        
        const hash = window.location.hash.substring(1);
        if (hash) {
            console.log("Processing URL hash for OAuth callback");
            const hashParams = new URLSearchParams(hash);
            token = hashParams.get('access_token');
            error = hashParams.get('error');
            
            const state = hashParams.get('state');
            if (state && state.startsWith('youtube_auth_')) {
                service = 'youtube';
                console.log("Found YouTube token in hash fragment:", !!token);
            } else {
                service = 'twitch';
                console.log("Found Twitch token:", !!token);
            }
        }
        
        const queryParams = new URLSearchParams(window.location.search);
        const code = queryParams.get('code');
        if (code) {
            console.log("Processing URL query for OAuth code flow");
            token = code;
            const state = queryParams.get('state');
            if (state && state.startsWith('youtube_auth_')) {
                service = 'youtube';
            } else {
                service = service || 'twitch';
            }
            
            if (!service) service = 'unknown';
            console.log("Found OAuth code for " + service + ":", !!code);
        }
        
        if (!error) {
            error = queryParams.get('error');
        }
        
        if (token) {
            console.log("Token found, sending to main process for service:", service);
            fetch('/auth-complete?token=' + encodeURIComponent(token) + '&service=' + service, { method: 'GET' })
                .then(response => {
                    document.body.innerHTML = `
                        <div class="container">
                            <h2>Authorization Successful</h2>
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                            <p style="color: #22c55e; font-size: 20px;">You have been successfully authenticated!</p>
                            <p style="font-size: 16px; margin-top: 10px;">You can close this window and return to StreamTTS.</p>
                        </div>
                    `;
                    document.body.style.backgroundColor = '#f0fff4';
                    
                    // Attempt to close the window (works in some browsers)
                    setTimeout(() => {
                        try {
                            window.close();
                        } catch (e) {
                            // Window cannot be closed programmatically, user will close manually
                        }
                    }, 1000);
                })
                .catch(err => {
                    console.error('Auth complete error:', err);
                    document.body.innerHTML = `
                        <div class="container">
                            <h2>Authentication Error</h2>
                            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="15" y1="9" x2="9" y2="15"></line>
                                <line x1="9" y1="9" x2="15" y2="15"></line>
                            </svg>
                            <p style="color: #ef4444; font-size: 20px;">Authentication error occurred</p>
                            <p>Please close this window and try again in the app.</p>
                        </div>
                    `;
                    document.body.style.backgroundColor = '#fff5f5';
                });
        } else if (error) {
            const errorMessage = error || 'Unknown error';
            document.body.innerHTML = `
                <div class="container">
                    <h2>Authentication Failed</h2>
                    <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    <p style="color: #ef4444; font-size: 20px;">Authentication failed: ${errorMessage}</p>
                    <p>Please close this window and try again.</p>
                </div>
            `;
            
            document.body.style.backgroundColor = '#fff5f5';
        }
    </script>
</body>
</html>